<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ç¡çœ è®°å½•</title>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --border: #e5e5ea; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 16px; max-width: 600px; margin: 0 auto; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        h2 { margin: 0 0 16px 0; font-size: 18px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        
        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; color: #8e8e93; margin-bottom: 6px; font-weight: 500; }
        .input-row { display: flex; gap: 10px; }
        input[type="datetime-local"], select, input[type="text"] {
            flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 10px;
            font-size: 16px; background: #fff; appearance: none; -webkit-appearance: none;
        }
        
        /* æŒ‰é’® */
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: opacity 0.2s; text-align: center; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-secondary { background: #e5e5ea; color: #000; width: auto; padding: 10px 16px; white-space: nowrap; }
        .btn-danger { background: #ff3b30; color: white; padding: 4px 10px; font-size: 12px; border-radius: 6px; margin-left: 5px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); font-size: 13px; padding: 8px 16px; }

        /* ç»Ÿè®¡è¡¨æ ¼ */
        .log-item { border-bottom: 1px solid var(--border); padding: 12px 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .log-item:last-child { border-bottom: none; }
        .log-date { font-weight: 600; font-size: 15px; }
        .log-meta { font-size: 12px; color: #8e8e93; margin-top: 2px; }
        .log-score { font-size: 18px; font-weight: 700; text-align: right; min-width: 40px; }
        .log-tags { display: flex; gap: 4px; justify-content: flex-end; margin-top: 4px; flex-wrap: wrap; }
        
        /* æ ‡ç­¾é¢œè‰² */
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .tag-green { background: #e4f9e8; color: #34c759; }
        .tag-red { background: #ffebeb; color: #ff3b30; }
        .tag-gray { background: #f2f2f7; color: #8e8e93; }
        
        .score-good { color: #34c759; }
        .score-bad { color: #ff3b30; }
        
        /* åº•éƒ¨å·¥å…·æ  */
        .toolbar { display: flex; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ“ è®°å½•ä»Šæ—¥ç¡çœ </h2>
        
        <div class="form-group">
            <label class="form-label">å…³å±æ—¶é—´ (Screen Off)</label>
            <div class="input-row">
                <input type="datetime-local" id="screenOff">
                <button class="btn btn-secondary" onclick="setNow('screenOff')">ç°åœ¨</button>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">ç†„ç¯æ—¶é—´ (Lights Out) *å¿…å¡«</label>
            <div class="input-row">
                <input type="datetime-local" id="lightsOut">
                <button class="btn btn-secondary" onclick="setNow('lightsOut')">ç°åœ¨</button>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">ç¡çœ è´¨é‡ & å¤‡æ³¨</label>
            <div class="input-row">
                <select id="quality" style="flex: 0 0 80px;">
                    <option value="5">5åˆ†</option>
                    <option value="4" selected>4åˆ†</option>
                    <option value="3">3åˆ†</option>
                    <option value="2">2åˆ†</option>
                    <option value="1">1åˆ†</option>
                </select>
                <input type="text" id="notes" placeholder="å¦‚ï¼šå–äº†å’–å•¡...">
            </div>
        </div>

        <button class="btn btn-primary" onclick="saveLog()">ä¿å­˜è®°å½•</button>
    </div>

    <div class="card">
        <h2>
            ğŸ“Š å†å²è®°å½•
            <span style="font-size:12px; color:#8e8e93; font-weight:400" id="avgScore"></span>
        </h2>
        <div id="logList">
            <!-- è®°å½•ä¼šæ’åœ¨è¿™é‡Œ -->
        </div>
    </div>

    <!-- æ•°æ®å¤‡ä»½åŒºåŸŸ -->
    <div style="text-align: center; margin-top: 30px; opacity: 0.6;">
        <p style="font-size:12px; margin-bottom:10px;">æ•°æ®ä¿å­˜åœ¨æ‰‹æœºæµè§ˆå™¨ç¼“å­˜ä¸­</p>
        <button class="btn btn-outline" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ® (å¤‡ä»½)</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
    </div>

<script>
    // ================= é€»è¾‘é…ç½®åŒº =================
    // ä½ å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹å“ªäº›å¤©ç®—â€œå‘¨æœ«â€(ç›®æ ‡00:30)
    // 5=å‘¨äº”, 6=å‘¨å…­, 0=å‘¨æ—¥ã€‚ å¦‚æœä½ å‘¨æ—¥æ™šä¸Šä¹Ÿæƒ³æ™šç¡ï¼Œå°±åŠ ä¸Š0: [5, 6, 0]
    const WEEKEND_DAYS = [5, 6]; 
    
    // ================= ç¨‹åºä¸»ä½“ =================
    document.addEventListener('DOMContentLoaded', loadLogs);

    function setNow(id) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById(id).value = now.toISOString().slice(0, 16);
    }

    function saveLog() {
        const lightsOutStr = document.getElementById('lightsOut').value;
        const screenOffStr = document.getElementById('screenOff').value;
        const quality = document.getElementById('quality').value;
        const notes = document.getElementById('notes').value;

        if (!lightsOutStr) { alert("å¿…é¡»å¡«å†™ç†„ç¯æ—¶é—´"); return; }

        const entry = {
            id: Date.now(),
            lightsOut: lightsOutStr,
            screenOff: screenOffStr,
            quality: quality,
            notes: notes
        };

        let logs = getLogs();
        logs.unshift(entry);
        localStorage.setItem('sleepLogs', JSON.stringify(logs));
        
        // é‡ç½®è¡¨å•
        document.getElementById('notes').value = '';
        loadLogs();
    }

    function getLogs() {
        return JSON.parse(localStorage.getItem('sleepLogs') || '[]');
    }

    function deleteLog(id) {
        if(!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
        let logs = getLogs().filter(l => l.id !== id);
        localStorage.setItem('sleepLogs', JSON.stringify(logs));
        loadLogs();
    }

    function loadLogs() {
        const logs = getLogs();
        const container = document.getElementById('logList');
        container.innerHTML = '';
        
        let totalPoints = 0;

        logs.forEach(log => {
            // 1. è®¡ç®—å½’å±æ—¥æœŸï¼ˆå¦‚æœæ˜¯å‡Œæ™¨12ç‚¹å‰ç¡ï¼Œç®—æ˜¨å¤©çš„ï¼‰
            const outDate = new Date(log.lightsOut);
            let adjustDate = new Date(outDate);
            if (outDate.getHours() < 12) {
                adjustDate.setDate(adjustDate.getDate() - 1);
            }
            
            // 2. åˆ¤æ–­å‘¨æœ«/å·¥ä½œæ—¥
            const dayOfWeek = adjustDate.getDay(); // 0-6
            const isWeekend = WEEKEND_DAYS.includes(dayOfWeek);
            
            // 3. è®¾å®šç›®æ ‡
            // å‘¨æœ«ç›®æ ‡ï¼šæ¬¡æ—¥00:30ï¼Œå·¥ä½œæ—¥ç›®æ ‡ï¼šæ¬¡æ—¥00:00
            let targetDate = new Date(adjustDate);
            targetDate.setDate(targetDate.getDate() + 1); // æ¬¡æ—¥
            targetDate.setHours(isWeekend ? 0 : 0, isWeekend ? 30 : 0, 0, 0);
            
            // 4. åˆ¤æ–­æ˜¯å¦å‡†æ—¶
            const isOnTime = outDate <= targetDate;
            
            // 5. åˆ¤æ–­ç¼“å†² (>=30min)
            let bufferMins = 0;
            let isBufferOk = false;
            if (log.screenOff) {
                const offDate = new Date(log.screenOff);
                bufferMins = Math.floor((outDate - offDate) / 1000 / 60);
                if (bufferMins >= 30) isBufferOk = true;
            }
            
            // 6. è®¡ç®—åˆ†æ•°
            let score = 0;
            if (isOnTime) score += 0.8;
            if (isBufferOk) score += 0.2;
            let points = Math.round(score * 10);
            totalPoints += points;

            // 7. æ¸²æŸ“HTML
            const dateStr = adjustDate.toLocaleDateString('zh-CN', {month:'2-digit', day:'2-digit', weekday:'short'});
            const timeStr = `${outDate.getHours()}:${String(outDate.getMinutes()).padStart(2,'0')}`;
            
            const html = `
                <div class="log-item">
                    <div>
                        <div class="log-date">${dateStr} <span style="font-weight:400; font-size:12px; color:#999">${isWeekend ? '(ä¼‘)' : '(ç­)'}</span></div>
                        <div class="log-meta">ç†„ç¯: ${timeStr} ${log.notes ? 'Â· ' + log.notes : ''}</div>
                    </div>
                    <div>
                        <div class="log-score ${points >= 8 ? 'score-good' : 'score-bad'}">${points}</div>
                        <div class="log-tags">
                            <span class="tag ${isOnTime ? 'tag-green' : 'tag-red'}">${isOnTime ? 'æ—©ç¡' : 'ç†¬å¤œ'}</span>
                            <span class="tag ${isBufferOk ? 'tag-green' : 'tag-gray'}">ç¼“å†²${bufferMins}m</span>
                        </div>
                        <div style="text-align:right; margin-top:5px;">
                             <button class="btn-danger" onclick="deleteLog(${log.id})">Ã—</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
        
        // æ›´æ–°å¹³å‡åˆ†
        if(logs.length > 0) {
            document.getElementById('avgScore').innerText = `å¹³å‡åˆ†: ${(totalPoints / logs.length).toFixed(1)}`;
        }
    }

    // ================= æ•°æ®å¯¼å…¥å¯¼å‡º =================
    function exportData() {
        const dataStr = localStorage.getItem('sleepLogs');
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sleep_data_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (confirm(`å‘ç° ${data.length} æ¡è®°å½•ï¼Œç¡®å®šè¦è¦†ç›–å½“å‰æ•°æ®å—ï¼Ÿ`)) {
                    localStorage.setItem('sleepLogs', JSON.stringify(data));
                    loadLogs();
                    alert("å¯¼å…¥æˆåŠŸï¼");
                }
            } catch (err) {
                alert("æ–‡ä»¶æ ¼å¼é”™è¯¯");
            }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
